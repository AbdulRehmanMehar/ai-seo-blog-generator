version: '3.8'

services:
  seo-blog-generator:
    build:
      context: .
      dockerfile: Dockerfile
    image: primestrides/seo-blog-generator:latest
    container_name: seo-blog-generator
    restart: unless-stopped
    
    # Environment variables - configure these in Portainer or use .env file
    environment:
      - NODE_ENV=production
      # Database connections
      - MYSQL_URL=${MYSQL_URL}
      - MYSQL_SSL=${MYSQL_SSL:-true}
      - MYSQL_SSL_REJECT_UNAUTHORIZED=${MYSQL_SSL_REJECT_UNAUTHORIZED:-true}
      - POSTGRES_URL=${POSTGRES_URL}
      - POSTGRES_SSL_REJECT_UNAUTHORIZED=${POSTGRES_SSL_REJECT_UNAUTHORIZED:-false}
      # Gemini API
      - GEMINI_API_KEYS=${G_API_KEYS}
      - GEMINI_GENERATION_MODEL=${GEMINI_GENERATION_MODEL:-gemini-2.5-flash}
      - GEMINI_EMBEDDING_MODEL=${GEMINI_EMBEDDING_MODEL:-gemini-embedding-001}
      # SERP APIs (optional - for keyword discovery)
      - SERPSTACK_APIS=${SERPSTACK_APIS:-}
      - SERPSTACK_MAX_LIMIT=${SERPSTACK_MAX_LIMIT:-100}
      - ZENSERP_APIS=${ZENSERP_APIS:-}
      - ZENSERP_MAX_LIMIT=${ZENSERP_MAX_LIMIT:-50}
      - SCRAPPER_X_API=${SCRAPPER_X_API:-}
      # Scheduling
      - CRON_SCHEDULE_1=${CRON_SCHEDULE_1:-15 9 * * *}
      - CRON_SCHEDULE_2=${CRON_SCHEDULE_2:-}
      # Rate limiting
      - LLM_MIN_SECONDS_BETWEEN_REQUESTS=${LLM_MIN_SECONDS_BETWEEN_REQUESTS:-10}
      - LLM_DAILY_REQUEST_CAP=${LLM_DAILY_REQUEST_CAP:-20}
      # Debug
      - DEBUG_GEMINI=${DEBUG_GEMINI:-0}
    
    # Optional: mount volumes for persistent data
    volumes:
      - ./data:/app/data:ro  # Author knowledge files (read-only)
    
    # No ports needed - this is a background scheduler
    # Uncomment if you add an API endpoint later
    # ports:
    #   - "3000:3000"
    
    # Resource limits (adjust based on your server)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Optional: Run migrations separately
  # Uncomment and run once: docker-compose run --rm migrate
  # migrate:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   command: ["node", "dist/db/migrate.js"]
  #   environment:
  #     - MYSQL_URL=${MYSQL_URL}
  #     - POSTGRES_URL=${POSTGRES_URL}
  #   profiles:
  #     - migrate

networks:
  default:
    name: primestrides-network
    external: true
